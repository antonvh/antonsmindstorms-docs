<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome to UartRemote documentation! &mdash; Anton&#39;s Mindstorms Docs  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Installation" href="../mpy-robot-tools/docs/index.html" />
    <link rel="prev" title="Welcome to the SerialTalk documentation!" href="../SerialTalk/serialtalk.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/logo_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Software</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">SerialTalk</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html#uartremote">UartRemote</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Welcome to UartRemote documentation!</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uartremote-library">UartRemote Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#platforms">Platforms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructor">Constructor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote"><code class="docutils literal notranslate"><span class="pre">UartRemote</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#methods">Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.flush"><code class="docutils literal notranslate"><span class="pre">UartRemote.flush()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.available"><code class="docutils literal notranslate"><span class="pre">UartRemote.available()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.send_command"><code class="docutils literal notranslate"><span class="pre">UartRemote.send_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.receive_command"><code class="docutils literal notranslate"><span class="pre">UartRemote.receive_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.call"><code class="docutils literal notranslate"><span class="pre">UartRemote.call()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.process_uart"><code class="docutils literal notranslate"><span class="pre">UartRemote.process_uart()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.reply_command"><code class="docutils literal notranslate"><span class="pre">UartRemote.reply_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.loop"><code class="docutils literal notranslate"><span class="pre">UartRemote.loop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.add_module"><code class="docutils literal notranslate"><span class="pre">UartRemote.add_module()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.add_command"><code class="docutils literal notranslate"><span class="pre">UartRemote.add_command()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.get_remote_commands"><code class="docutils literal notranslate"><span class="pre">UartRemote.get_remote_commands()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#helper-methods">Helper Methods</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Uartremote.command"><code class="docutils literal notranslate"><span class="pre">Uartremote.command</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.encode"><code class="docutils literal notranslate"><span class="pre">UartRemote.encode()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.decode"><code class="docutils literal notranslate"><span class="pre">UartRemote.decode()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.read_all"><code class="docutils literal notranslate"><span class="pre">UartRemote.read_all()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#UartRemote.force_read"><code class="docutils literal notranslate"><span class="pre">UartRemote.force_read()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remote-module-loading">Remote module loading</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-remotely-load-a-module">How to remotely load a module?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#protocol">Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#packet-format">Packet format</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#uartremote-for-arduino">UartRemote for Arduino</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#differences-compared-to-micropython-implementation">Differences compared to MicroPython implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api">API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arguments-struct">Arguments struct</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#struct-library">Struct library</a></li>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html#mpy-robot-tools">MPY Robot Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Hardware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware/index.html">LMS-ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware/index.html#opemmv-uart-convertor-board">OpemMV Uart Convertor board</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware/index.html#distance-sensor-breakout-board">Distance Sensor Breakout board</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware/index.html#lms-esp8266">LMS-ESP8266</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Firmware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Firmware/index.html">Micropython</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Firmware/index.html#bluepad32">BluePad32</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anton's Mindstorms Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">SerialTalk</a></li>
      <li class="breadcrumb-item active">Welcome to UartRemote documentation!</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Software/UartRemote/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="welcome-to-uartremote-documentation">
<h1>Welcome to UartRemote documentation!<a class="headerlink" href="#welcome-to-uartremote-documentation" title="Permalink to this heading"></a></h1>
<p>This is a library for robust, near real-time communication between two UART devices. We developed it on python 3.9 with LEGO EV3, SPIKE Prime and other MicroPython (ESP/STM32) modules. The library is available on github: <a class="reference external" href="https://github.com/antonvh/UartRemote">UartRemote on GitHub</a>.
The library has the following properties:</p>
<ul class="simple">
<li><p>It is fast enough to read sensor data at 30-50Hz.</p></li>
<li><p>It is fully symmetrical, so master and slave can have the same import.</p></li>
<li><p>It includes a RAW REPL mode to upload code to a slave module. This means you can develop code for both modules in one file.</p></li>
<li><p>It is implemented in MicroPython and Arduino/C code. With arduino code, much higher sensor reading speeds are possible, but flashing is a bit less user friendly.</p></li>
<li><p>The library has a command loop to wait and listen for calls. That loop is customizable and non-blocking so you can add your own code to it.</p></li>
<li><p>The python-struct-like encoding is included in the payload, so the other side always knows how to decode it.</p></li>
<li><p>Compatable with most RS232-TTL 3.3v/5v converter board to further expand i/o possibilities.</p></li>
<li><p>Remote modiule importing</p></li>
</ul>
<p>Usage: you can use all of parts of this library for your own projects. Please give us credits at least. We put a lot spare time in this. You are also welcome to contribute. Please fork and PR.</p>
</section>
<section id="uartremote-library">
<h1>UartRemote Library<a class="headerlink" href="#uartremote-library" title="Permalink to this heading"></a></h1>
<p>This library implements a class with methods that help to set up robust communication between instances running MicroPython which are connected over a UART interface.</p>
<p>The library is available on github:  <a class="reference external" href="https://github.com/antonvh/UartRemote">UartRemote on GitHub</a>.</p>
<section id="platforms">
<h2>Platforms<a class="headerlink" href="#platforms" title="Permalink to this heading"></a></h2>
<p>The following platforms are supported:</p>
<ul class="simple">
<li><p>Lego EV3</p></li>
<li><p>Lego Mindstroms Robot Inventor 51515</p></li>
<li><p>Lego SPIKE Prime</p></li>
<li><p>Espressif ESP8266</p></li>
<li><p>Espressif ESP32</p></li>
<li><p>Espressif ESP32-S2</p></li>
<li><p>OpenMV H7 and M7 (STM32 chipset)</p></li>
<li><p>MaixPy (K210 chipset)</p></li>
<li><p>Windows</p></li>
<li><p>Mac OSX</p></li>
</ul>
<p>These platforms are automatically detected by querying <code class="docutils literal notranslate"><span class="pre">sys.platform</span></code>. Within <code class="docutils literal notranslate"><span class="pre">uartremote.py</span></code> these platforms are defined by the constants: <code class="docutils literal notranslate"><span class="pre">_EV3,_SPIKE,_ESP8266,_ESP32,_ESP32_S2,_H7,_K210,_MAC,_WIN32</span></code>, respectively. There are small differences in the implementation of MicroPython for these platforms. The <code class="docutils literal notranslate"><span class="pre">UartRemote</span></code> takes these into account based on the platform type.</p>
</section>
<section id="constructor">
<h2>Constructor<a class="headerlink" href="#constructor" title="Permalink to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="UartRemote">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">UartRemote</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">port</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">baudrate</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">115200</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1500</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rx_pin</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">18</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">tx_pin</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">19</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote" title="Permalink to this definition"></a></dt>
<dd><blockquote>
<div><p>Construct a UartRemote object on the port given by:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code> identifies a port for using the UART.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">port</span></code> is board specific:</p>
<blockquote>
<div><ul class="simple">
<li><p>SPIKE: port = : has one I2S bus with id=2.</p></li>
<li><p>ESP8266: port = 0.</p></li>
<li><p>ESP32: Use 1 for UART1.</p></li>
</ul>
</div></blockquote>
<p>The following keyword arguments are supported on all platforms:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code> is the hardware uart port used to by <cite>UartRemote</cite> class; for LEGO it indicated the harware port, i.e. “A”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">baudrate</span></code> is the baudrate at which the UART communicates, defaults to 115200</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timeout</span></code> is the timeout (in ms) for waiting for data coming in on the UART in the <code class="docutils literal notranslate"><span class="pre">receive_command()</span></code>, default to 1500</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">debug</span></code> is a Boolean flag to generate debug output, default to False</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>Only for ESP32 platform:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rx_pin</span></code> is only used for ESP32 and indicates the  pin on which the UART will receive information, default to 18</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tx_pin</span></code> is the pin on which the UART will receive information, default to 19</p></li>
</ul>
</div></blockquote>
</dd></dl>

</section>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading"></a></h2>
<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.flush">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">flush</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.flush" title="Permalink to this definition"></a></dt>
<dd><p>Flushes the read buffer, by reading all remaining bytes from the Uart.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.available">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">available</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.available" title="Permalink to this definition"></a></dt>
<dd><p>Return a non zero value if there is a received command available. Note: on the SPIKE prime, you should use the <code class="docutils literal notranslate"><span class="pre">receive_command</span></code> or the <code class="docutils literal notranslate"><span class="pre">execute_command</span></code>, always with the parameter <code class="docutils literal notranslate"><span class="pre">reply=False</span></code>, after using the <code class="docutils literal notranslate"><span class="pre">available()</span></code> method.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.send_command">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">send_command</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">type_data</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.send_command" title="Permalink to this definition"></a></dt>
<dd><p>Sends a command <code class="docutils literal notranslate"><span class="pre">command</span></code>. <code class="docutils literal notranslate"><span class="pre">*type_data</span></code> are a number of argument that consist of a type defintion <code class="docutils literal notranslate"><span class="pre">t</span></code>, followed by one ore more variables of the type corresponding with the paramater <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>
<span class="n">ur</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s1">&#39;led_color&#39;</span><span class="p">,</span><span class="s1">&#39;4B&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="c1"># will encode a command to remotely calls the function ``led_color``</span>
<span class="c1"># where the values of the variables ``n,t,g,b`` are passed to that function.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.receive_command">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">receive_command</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">wait</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.receive_command" title="Permalink to this definition"></a></dt>
<dd><p>Receives a command and returns a tuple <code class="docutils literal notranslate"><span class="pre">(&lt;command&gt;,</span> <span class="pre">&lt;data&gt;)</span></code>.  If there is a failure, the <code class="docutils literal notranslate"><span class="pre">&lt;command&gt;</span></code>  will be equal to <cite>‘err’</cite>. If <code class="docutils literal notranslate"><span class="pre">wait</span></code> is True, the methods waits until it receives a command.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.call">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">call</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">type_data</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.call" title="Permalink to this definition"></a></dt>
<dd><p>Sends a command to a remote host that is waiting for a call and will wait until an answer comes back.
Optionally a parameter <code class="docutils literal notranslate"><span class="pre">timeout=...</span></code> for the answer is self.timout, or passable as timeout=…</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.process_uart">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">process_uart</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sleep</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">-2</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.process_uart" title="Permalink to this definition"></a></dt>
<dd><p>Processes a remote call if there is any. Upon receiving a remote call, the command is processed and the result is send back by internally calling the <code class="docutils literal notranslate"><span class="pre">reply_command</span></code> method. Sleeps for <code class="docutils literal notranslate"><span class="pre">sleep</span></code> ms after every listen. This method is only used in a loop and is non-blocking (as not for the sleep period).</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.reply_command">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">reply_command</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">command</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.reply_command" title="Permalink to this definition"></a></dt>
<dd><p>Processes the received command by calling the function with name <cite>command(value)</cite> and passes the arguments as defined in <code class="docutils literal notranslate"><span class="pre">value</span></code>. The result of this function call is send back by calling the <code class="docutils literal notranslate"><span class="pre">send_command(ack_command,result)</span></code> method with  with the <code class="docutils literal notranslate"><span class="pre">ack_command</span></code> is the received command prepended with <cite>ack_</cite> and the result (if any) is the return value of the function formatted according to the functions format string.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.loop">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">loop</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.loop" title="Permalink to this definition"></a></dt>
<dd><p>This is an endless loop around the <code class="docutils literal notranslate"><span class="pre">process_uart</span></code> method, replying on all incoming calls. The slave side instants typically has the following code running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uartremote</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">ur</span> <span class="o">=</span> <span class="n">UartRemote</span><span class="p">()</span>
<span class="n">ur</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span> <span class="c1"># wait for incoming commands</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.add_module">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">add_module</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">module_name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.add_module" title="Permalink to this definition"></a></dt>
<dd><p>Sends a command to the other side instructing it to import the module with name <code class="docutils literal notranslate"><span class="pre">module_name</span></code>. The <code class="docutils literal notranslate"><span class="pre">module_name</span></code> argument has type string. After importing the module, the remote side calls the function <cite>&lt;module&gt;.add_commands()</cite>. This is a function that you should add to the modules you want to remotely import. See for usage <a class="reference internal" href="#examples-load-module"><span class="std std-ref">Example load module</span></a>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.add_command">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">add_command</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command_function</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.add_command" title="Permalink to this definition"></a></dt>
<dd><p>Adds a command <cite>command</cite> to the dictionary of <code class="docutils literal notranslate"><span class="pre">UartRemote.commands</span></code> together with a function name <code class="docutils literal notranslate"><span class="pre">command_function</span></code>. Optionally, if the <code class="docutils literal notranslate"><span class="pre">command_function</span></code> returns any parameters, the <code class="docutils literal notranslate"><span class="pre">format_string</span></code> describes the type of the returned parameters. If the <code class="docutils literal notranslate"><span class="pre">command_function</span></code> does not return a value, the <cite>format_string</cite> is ommited. The dictionary with commands is used by the <code class="docutils literal notranslate"><span class="pre">UartRemote.reply_command()</span></code> method to call the function as defined upon receiving a specific command. As an argument the <code class="docutils literal notranslate"><span class="pre">data</span></code> that is received is used.</p>
<p>Below is an example of how to use the <code class="docutils literal notranslate"><span class="pre">add_command</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
  <span class="c1"># example function receiving two arguments and returning the sum of a and b</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>

<span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">example</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">ur</span></code> is the instantiation of the <code class="docutils literal notranslate"><span class="pre">UartRemote</span></code> class and the function <code class="docutils literal notranslate"><span class="pre">example</span></code> will return the sum as type float.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.get_remote_commands">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">get_remote_commands</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.get_remote_commands" title="Permalink to this definition"></a></dt>
<dd><p>Returns an array containing the commands available by the remote uartremote. You will see a number of default built-in commands such as <cite>echo</cite>. This method can be used to query the commands that are added by remotely importing a new module.  See for usage <a class="reference internal" href="#examples-load-module"><span class="std std-ref">Example load module</span></a>.</p>
</dd></dl>

</section>
<section id="helper-methods">
<h2>Helper Methods<a class="headerlink" href="#helper-methods" title="Permalink to this heading"></a></h2>
<p>The methods below are internally called by the methods listed above. You can use these methods should you like to have more low level control.</p>
<dl class="py data">
<dt class="sig sig-object py" id="Uartremote.command">
<span class="sig-prename descclassname"><span class="pre">Uartremote.</span></span><span class="sig-name descname"><span class="pre">command</span></span><a class="headerlink" href="#Uartremote.command" title="Permalink to this definition"></a></dt>
<dd><p>Dictionary with the mapping of command name to corresponding functions.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.encode">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">encode</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">command</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">typedata</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.encode" title="Permalink to this definition"></a></dt>
<dd><p>Encodes a command <code class="docutils literal notranslate"><span class="pre">command</span></code>. <code class="docutils literal notranslate"><span class="pre">*type_data</span></code> are a number of arguments that consist of a type defintion <code class="docutils literal notranslate"><span class="pre">t</span></code>, followed by one ore more variables of the type corresponding with the paramater <code class="docutils literal notranslate"><span class="pre">t</span></code>.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>
<span class="n">ur</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;led_color&#39;</span><span class="p">,</span><span class="s1">&#39;4B&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x11\t</span><span class="s1">led_color</span><span class="se">\x02</span><span class="s1">4B</span><span class="se">\x01\x02\x03\x04</span><span class="s1">&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.decode">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">decode</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bytestr</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.decode" title="Permalink to this definition"></a></dt>
<dd><p>Decodes an encoded bytestring <code class="docutils literal notranslate"><span class="pre">bytestr</span></code> as a tuple with the command and the parameters. If a command without parameters was encoded, the parameters will be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>
<span class="n">ur</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x11\t</span><span class="s1">led_color</span><span class="se">\x02</span><span class="s1">4B</span><span class="se">\x01\x02\x03\x04</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="s1">&#39;led_color&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.read_all">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">read_all</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.read_all" title="Permalink to this definition"></a></dt>
<dd><p>Returns all bytes that are available in the UART receive buffer.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="UartRemote.force_read">
<span class="sig-prename descclassname"><span class="pre">UartRemote.</span></span><span class="sig-name descname"><span class="pre">force_read</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">50</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#UartRemote.force_read" title="Permalink to this definition"></a></dt>
<dd><p>Some platforms read too fast from the UART and return 0 or None. This method loops until it receives a valid number of <code class="docutils literal notranslate"><span class="pre">size</span></code> bytes within <code class="docutils literal notranslate"><span class="pre">timeout</span></code> ms.</p>
</dd></dl>

<section id="examples">
<span id="id2"></span><h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h3>
<p>Basic encoding</p>
</section>
</section>
<section id="remote-module-loading">
<span id="examples-load-module"></span><h2>Remote module loading<a class="headerlink" href="#remote-module-loading" title="Permalink to this heading"></a></h2>
<p>The ESP32 micropython only has a single REPL prompt working properly on UART0 (the primary UART used for uploading firmware). Consequently, the commands in the <cite>UartRemote</cite> library for starting and stopping the remote REPL do not work and we can not use the remote REPL for uploading Python code to the remote micropython instance.</p>
<p>A simple solution would be to initate the code on the ESP32 as <cite>main.py</cite> and have it executing upon reset. This does not allow to change the software running on the ESP32 without reprogramming it.</p>
<p>Therefore, we came up with the following idea. By saving the different programs on the ESP32 as seperate modules, the remote side can choose which module it should load. The loaded module populates the list of remote commands with the functions that it implements. After that the remote commands can be <cite>call</cite>-ed by the remote side. In this way the remote side can decide at run time which commands it can execute on the ESP32.</p>
</section>
<section id="how-to-remotely-load-a-module">
<h2>How to remotely load a module?<a class="headerlink" href="#how-to-remotely-load-a-module" title="Permalink to this heading"></a></h2>
<p>We illustrate the way this works by giving an example.</p>
<p>The ESP32 runs the following commands in its <code class="docutils literal notranslate"><span class="pre">main.py</span></code> program:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uartremote</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>         <span class="c1"># initialize uartremote on default uart and default uart pins</span>
<span class="n">ur</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>               <span class="c1"># start listing for commands received from the remote instance</span>
</pre></div>
</div>
<p>Furthermore, on the ESP32 we have the following code saved as the module <code class="docutils literal notranslate"><span class="pre">test.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># module test.py</span>

<span class="k">def</span> <span class="nf">led</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
  <span class="c1"># code for turning on led n using color (r,g,b)</span>
  <span class="c1"># now we only print the received data</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">collect_data</span><span class="p">():</span>
  <span class="c1"># code for pulling tuple</span>
  <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;ABC&#39;</span><span class="p">,</span><span class="mi">123</span><span class="p">),(</span><span class="s1">&#39;ABC&#39;</span><span class="p">,</span><span class="mf">123.456</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">add_commands</span><span class="p">(</span><span class="n">ur</span><span class="p">):</span> <span class="c1"># call for adding the functions in this module to UartRemote commands</span>
  <span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">led</span><span class="p">)</span> <span class="c1"># does not return any value</span>
  <span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">read_temp</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="c1"># returns an integer</span>
  <span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">collect_data</span><span class="p">,</span><span class="s1">&#39;repr&#39;</span><span class="p">)</span> <span class="c1"># returns string</span>
</pre></div>
</div>
<p>When the module above is imported, the function <code class="docutils literal notranslate"><span class="pre">add_commands</span></code> will add the two functions that are defined in this module to the current command set of UartRemote. Therefore, this function should be present in your modules that you want to remotely import.</p>
<p>On the master instance (e.g. the Lego robot, where the ESP32 is connected to port ‘A’), we use the following code to remotely import the <code class="docutils literal notranslate"><span class="pre">test</span></code> module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># code running on remote instance</span>
<span class="kn">from</span> <span class="nn">projects.uartremote</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>

<span class="n">cmds_before</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">get_remote_commands</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span><span class="n">cmds_before</span><span class="p">)</span>

<span class="c1"># remotely import module `test`</span>
<span class="n">ur</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="n">cmds_after</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">get_remote_commands</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;new commands:&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cmds_after</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">cmds_before</span><span class="p">)))</span>

<span class="n">ack</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;4B&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>

<span class="n">ack</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;read_temp&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;read_temp&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

<span class="n">ack</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;collect_data&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;collect_data&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this program gives the following output:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">before</span> <span class="p">[</span><span class="s1">&#39;enable repl&#39;</span><span class="p">,</span> <span class="s1">&#39;disable repl&#39;</span><span class="p">,</span> <span class="s1">&#39;echo&#39;</span><span class="p">,</span> <span class="s1">&#39;raw echo&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;get_num_commands&#39;</span><span class="p">,</span> <span class="s1">&#39;get_nth_command&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new</span> <span class="n">commands</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;read_temp&#39;</span><span class="p">,</span> <span class="s1">&#39;led&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">read_temp</span> <span class="mi">37</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">collect_data</span> <span class="p">[(</span><span class="s1">&#39;ABC, 123&#39;</span><span class="p">),(</span><span class="s1">&#39;ABC&#39;</span><span class="p">,</span><span class="mf">123.456</span><span class="p">)]</span>
</pre></div>
</div>
<p>and on the ESP32 we see:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">1</span> <span class="mi">100</span> <span class="mi">200</span> <span class="mi">150</span>
</pre></div>
</div>
</section>
</section>
<section id="protocol">
<h1>Protocol<a class="headerlink" href="#protocol" title="Permalink to this heading"></a></h1>
<p>The communication between different UartRemote instances uses a self-described packet format. This section describes the packet format in detail.</p>
<section id="packet-format">
<h2>Packet format<a class="headerlink" href="#packet-format" title="Permalink to this heading"></a></h2>
<p>When a command with its accompanying values is transmitted over the Uart, the following packet format is used:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 13%" />
<col style="width: 16%" />
<col style="width: 13%" />
<col style="width: 15%" />
<col style="width: 10%" />
<col style="width: 15%" />
<col style="width: 7%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>start</p></th>
<th class="head"><p>total len</p></th>
<th class="head"><p>command len</p></th>
<th class="head"><p>command</p></th>
<th class="head"><p>format len</p></th>
<th class="head"><p>format</p></th>
<th class="head"><p>data</p></th>
<th class="head"><p>end</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">&lt;</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ln</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lc</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cmd</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lf</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">f</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">data</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&gt;</span></code></p></td>
</tr>
</tbody>
</table>
<p>with</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ln</span></code> the length of the total packet encoded as a single byte,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lc</span></code> the length of the command string <cite>&lt;cmd&gt;</cite> as a single byte,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cmd</span></code> the command specified as a string,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lf</span></code> the length of the format string</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f</span></code> the Format encapsulation to pack the values; This can be <code class="docutils literal notranslate"><span class="pre">repr</span></code> for encapsulating arbitrary objects, <code class="docutils literal notranslate"><span class="pre">raw</span></code> for no encapsulation, or a Python struct format string.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> a number of values encapsulated according to <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p></li>
</ul>
<p>The whole message is sandwiched between a <cite>start</cite> and <cite>end</cite> delimitter <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>.</p>
<p>When the method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span><span class="s1">&#39;repr&#39;</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
<p>is used, the following packet will be transmitted over the line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;&lt;b&#39;</span>\<span class="n">x1c</span>\<span class="n">x04test</span>\<span class="n">x04repr</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],)</span><span class="o">&gt;</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>This option interpretes the Format string <cite>f</cite> as the format string of the <cite>struct.pack/unpack</cite> method (see <a class="reference external" href="https://docs.python.org/3/library/struct.html">https://docs.python.org/3/library/struct.html</a>), for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send_command</span><span class="p">(</span><span class="s1">&#39;test_struct&#39;</span><span class="p">,</span><span class="s1">&#39;3b3s1f&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;ale&quot;</span><span class="p">,</span><span class="mf">1.3</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
<p>This is the fastest method (1ms) but is limited to c-types, like int, unsigned int etc…</p>
<p>This uses the string representation of data, <code class="docutils literal notranslate"><span class="pre">repr()</span></code> to encode it. Then <code class="docutils literal notranslate"><span class="pre">eval()</span></code> is used on the receiving end.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;test_command&#39;</span><span class="p">,</span> <span class="s1">&#39;repr&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]])</span>
</pre></div>
</div>
<p>will be encoded as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;%</span><span class="se">\x0c</span><span class="s1">test_command</span><span class="se">\x04</span><span class="s1">repr([[1, 2], [3, 4]],)&#39;</span>
</pre></div>
</div>
<p>Here’s the power of repr:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;test_command&#39;</span><span class="p">,</span><span class="s1">&#39;repr&#39;</span><span class="p">,[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">3</span><span class="p">,</span><span class="nb">str</span><span class="p">],[</span><span class="nb">len</span><span class="p">,</span><span class="kc">True</span><span class="p">],[</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="p">]])</span>
</pre></div>
</div>
<p>becomes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s2">&quot;W</span><span class="se">\x0c</span><span class="s2">test_command</span><span class="se">\x04</span><span class="s2">repr([[1, 2], [3, &lt;class &#39;str&#39;&gt;], [&lt;built-in function len&gt;, True], [5]],)&quot;</span>
</pre></div>
</div>
<p>This is slower (7ms) and incompatible with Arduino but it is more flexible.</p>
<p>This is the fastest option of all, but you’ll have to do your own decoding/encoding.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;test_command&#39;</span><span class="p">,</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s1">&#39;abcd&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>is encoded as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x15\x0c</span><span class="s1">test_command</span><span class="se">\x03</span><span class="s1">rawabcd&#39;</span>
</pre></div>
</div>
<p>The type of <cite>&lt;data&gt;</cite> is given according to the [struct Format characters](<a class="reference external" href="https://docs.python.org/3/library/struct.html">https://docs.python.org/3/library/struct.html</a>), of which the most commonly used are shown below:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 35%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Format character</p></th>
<th class="head"><p>type</p></th>
<th class="head"><p>number of bytes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">b</span></code></p></td>
<td><p><cite>byte</cite></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">B</span></code></p></td>
<td><p><cite>unsigned byte</cite></p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">i</span></code></p></td>
<td><p><cite>int</cite></p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">I</span></code></p></td>
<td><p><cite>unsigned int</cite></p></td>
<td><p>4</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">f</span></code></p></td>
<td><p><cite>float</cite></p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">d</span></code></p></td>
<td><p><cite>double</cite></p></td>
<td><p>8</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">s</span></code></p></td>
<td><p><cite>string[]</cite></p></td>
<td><p>one per char</p></td>
</tr>
</tbody>
</table>
<p>example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;mycommand&#39;</span><span class="p">,</span><span class="s1">&#39;bb3sb&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;aha&quot;</span><span class="p">,</span><span class="mi">120</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that struct DOES NOT decode utf-8. You will always get a bytestring on the other side. It uses about 1ms to encode/decode.</p>
<p>Special format strings for other encoding types</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">repr</span></code>: use for a pickle-like serialized string encoding/decoding</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raw</span></code> : skip encoding altogether and just pas one raw byte string.</p></li>
</ul>
<p>example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;mycommand&#39;</span><span class="p">,</span><span class="s1">&#39;repr&#39;</span><span class="p">,[[</span><span class="mi">12</span><span class="p">,</span><span class="mi">34</span><span class="p">],[</span><span class="mi">56</span><span class="p">,</span><span class="mi">78</span><span class="p">]],</span><span class="s2">&quot;tekst&quot;</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>This will get all the python types across, but uses about 7ms to encode/decode.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;mycommand&#39;</span><span class="p">,</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span><span class="sa">b</span><span class="s2">&quot;Raw byte string&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the encoder fails it resorts to raw bytes by default.</p>
</div>
</section>
</section>
<section id="uartremote-for-arduino">
<h1>UartRemote for Arduino<a class="headerlink" href="#uartremote-for-arduino" title="Permalink to this heading"></a></h1>
<p>This library is from a protocol point of view compatible with the MicroPython UartRemote library. It can be used in any Arduino project by adding this whole directory to the Arduino library directory. After importing the <cite>UartRemote</cite> library, an example can be selected form the examples in the Arduino IDE. Because this library is written in pure C++, it is faster by a factor of approximately 100 compared to the MicroPython implementation.</p>
<section id="differences-compared-to-micropython-implementation">
<h2>Differences compared to MicroPython implementation<a class="headerlink" href="#differences-compared-to-micropython-implementation" title="Permalink to this heading"></a></h2>
<p>Because C++ lacks the possibility to generate a function call with a variable number of parameters, a conversion function <code class="docutils literal notranslate"><span class="pre">unpack</span></code> was introduced.</p>
<p>A typical definition of a user defined function that will be called upon receiving a command with its accompanying parameters is shown below:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">led</span><span class="p">(</span><span class="n">Arguments</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">unpack</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="o">&amp;</span><span class="n">g</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;LED on: %d, %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">uartremote</span><span class="p">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;ledack&quot;</span><span class="p">,</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Here, the user function takes always a single parameters of type <code class="docutils literal notranslate"><span class="pre">Arguments</span></code>. To obtain the encoded variables, the <code class="docutils literal notranslate"><span class="pre">unpack</span></code> function is called.</p>
<p>The user defined function must always return an acknowledgement. In this case a dummy variable of type <code class="docutils literal notranslate"><span class="pre">byte</span></code> is returned.</p>
<p>The following example shows how to return one or more values back.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">Arguments</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">unpack</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;sum on: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="o">=</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">uartremote</span><span class="p">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;imuack&quot;</span><span class="p">,</span><span class="s">&quot;i&quot;</span><span class="p">,</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In this example the sum of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> is returned as an integer (<code class="docutils literal notranslate"><span class="pre">i</span></code>).</p>
</section>
<section id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this heading"></a></h2>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote15receive_commandE">
<span id="_CPPv3N10UartRemote15receive_commandE"></span><span id="_CPPv2N10UartRemote15receive_commandE"></span><span class="n"><span class="pre">Arguments</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">receive_command</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">cmd</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd><p>Waits for an incomming command and return the received command in <code class="docutils literal notranslate"><span class="pre">cmd</span></code> and returns the format and buffer in the struct <code class="docutils literal notranslate"><span class="pre">Arguments</span></code>. The struct member <code class="docutils literal notranslate"><span class="pre">.error</span></code> has value 0 when no error occur.</p>
</dd></dl>

<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote12send_commandE">
<span id="_CPPv3N10UartRemote12send_commandE"></span><span id="_CPPv2N10UartRemote12send_commandE"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">send_command</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">cmd</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">format</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Send a command <code class="docutils literal notranslate"><span class="pre">cmd</span></code> over the UART where the vaiavle arguments are formatted according to the <code class="docutils literal notranslate"><span class="pre">format</span></code> string.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote4callE">
<span id="_CPPv3N10UartRemote4callE"></span><span id="_CPPv2N10UartRemote4callE"></span><span class="n"><span class="pre">Arguments</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">call</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">cmd</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">format</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Calls remotely the function specified by <code class="docutils literal notranslate"><span class="pre">cmd</span></code> and returns the result in a struct of type <code class="docutils literal notranslate"><span class="pre">Argument</span></code>. The struct member <code class="docutils literal notranslate"><span class="pre">.error</span></code> equals 1 if an error occured.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote15receive_executeE">
<span id="_CPPv3N10UartRemote15receive_executeE"></span><span id="_CPPv2N10UartRemote15receive_executeE"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">receive_execute</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><br /></dt>
<dd></dd></dl>

<p>Receives a command and executes the corresponding local function with the parameters as received from the command. This is a combination of <code class="docutils literal notranslate"><span class="pre">receive_command</span></code> and <code class="docutils literal notranslate"><span class="pre">command</span></code>. Returns 0 if no errors occurred.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote11add_commandE">
<span id="_CPPv3N10UartRemote11add_commandE"></span><span id="_CPPv2N10UartRemote11add_commandE"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">add_command</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">cmd</span></span>, <span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="p"><span class="pre">(</span></span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">func</span></span><span class="p"><span class="pre">)</span></span><span class="p"><span class="pre">(</span></span><span class="n"><span class="pre">Arguments</span></span><span class="p"><span class="pre">)</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Adds a function to the list of commands. In the example below, the function <code class="docutils literal notranslate"><span class="pre">tst</span></code> is added:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">def</span><span class="w"> </span><span class="nf">tst</span><span class="p">(</span><span class="n">Arguments</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">uartremote</span><span class="p">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&quot;tst&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tst</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote7commandE">
<span id="_CPPv3N10UartRemote7commandE"></span><span id="_CPPv2N10UartRemote7commandE"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">command</span></span></span><span class="sig-paren">(</span><span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">cmd</span></span>, <span class="n"><span class="pre">Arguments</span></span><span class="w"> </span><span class="n sig-param"><span class="pre">rcvunpack</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Executes the function by looking up the <code class="docutils literal notranslate"><span class="pre">cmd</span></code> string in the internal <code class="docutils literal notranslate"><span class="pre">cmds</span></code> array that is filled using the <code class="docutils literal notranslate"><span class="pre">add_command</span></code> method and maps function names as sring to the actual function pointers.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote9availableE">
<span id="_CPPv3N10UartRemote9availableE"></span><span id="_CPPv2N10UartRemote9availableE"></span><span class="kt"><span class="pre">int</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">available</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Checks whether a character is available in the UART receive buffer. This can be used for a non-blocking implementation of UartRemote in your own loop.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote5flushE">
<span id="_CPPv3N10UartRemote5flushE"></span><span id="_CPPv2N10UartRemote5flushE"></span><span class="kt"><span class="pre">void</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">flush</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Flushes the UART receive buffer. This can be used if an error is suspected.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote4packE">
<span id="_CPPv3N10UartRemote4packE"></span><span id="_CPPv2N10UartRemote4packE"></span><span class="n"><span class="pre">Arguments</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">pack</span></span></span><span class="sig-paren">(</span><span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">buf</span></span>, <span class="k"><span class="pre">const</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="p"><span class="pre">*</span></span><span class="n sig-param"><span class="pre">format</span></span>, <span class="p"><span class="pre">...</span></span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Packs the variatic list of arguments according to the <code class="docutils literal notranslate"><span class="pre">format</span></code> string in the buffer <code class="docutils literal notranslate"><span class="pre">buf</span></code>.</p>
<dl class="cpp member">
<dt class="sig sig-object cpp" id="_CPPv4N10UartRemote11readserial1E">
<span id="_CPPv3N10UartRemote11readserial1E"></span><span id="_CPPv2N10UartRemote11readserial1E"></span><span class="kt"><span class="pre">unsigned</span></span><span class="w"> </span><span class="kt"><span class="pre">char</span></span><span class="w"> </span><span class="sig-prename descclassname"><span class="n"><span class="pre">UartRemote</span></span><span class="p"><span class="pre">::</span></span></span><span class="sig-name descname"><span class="n"><span class="pre">readserial1</span></span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><span class="p"><span class="pre">;</span></span><br /></dt>
<dd></dd></dl>

<p>Reads a single byte from the UART receive buffer.</p>
</section>
<section id="arguments-struct">
<h2>Arguments struct<a class="headerlink" href="#arguments-struct" title="Permalink to this heading"></a></h2>
<p>We use a struct <code class="docutils literal notranslate"><span class="pre">Arguments</span></code> to store the format string together with the buffer with the unpacked data. The <code class="docutils literal notranslate"><span class="pre">friend</span> <span class="pre">unpack</span></code> function takes care for the proper unpacking of the buffer according to the format string. The <code class="docutils literal notranslate"><span class="pre">.error</span></code> struct member is used for passing error status back.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">Arguments</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">fmt</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span><span class="w"> </span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="k">friend</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">unpack</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Arguments</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">...</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">struct_unpack</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span><span class="n">a</span><span class="p">.</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">...);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>Examples<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h2>
<p>Below are some code snippets showing to use the Arduino side as a master and as a slave with its counter part written in Python.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"> </span><span class="c1">// global temporary storage for command names</span>

<span class="n">UartRemote</span><span class="w"> </span><span class="n">uartremote</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="w">  </span><span class="n">uartremote</span><span class="p">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&quot;led&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">uartremote</span><span class="p">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">add</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uartremote</span><span class="p">.</span><span class="n">receive_execute</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;error in receiving command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>With on the Python side the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uartremote</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">utime</span> <span class="kn">import</span> <span class="n">sleep_ms</span>
<span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>

<span class="n">ur</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="n">ack</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;2i&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sum = &quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
  <span class="n">sleep_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
  <span class="n">ur</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="s1">&#39;4i&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">sleep_ms</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
<p>The other way round it would look like:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="n">cmd</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"> </span><span class="c1">// global temporary storage for command names</span>

<span class="n">UartRemote</span><span class="w"> </span><span class="n">uartremote</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">i</span><span class="o">%=</span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">args</span><span class="o">=</span><span class="n">uartremote</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;led&quot;</span><span class="p">,</span><span class="s">&quot;4i&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">error</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;received ledack: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">cmd</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;error from call led</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);}</span><span class="w"></span>
<span class="w">  </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">args</span><span class="o">=</span><span class="n">uartremote</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;add&quot;</span><span class="p">,</span><span class="s">&quot;2i&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">error</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unpack</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received sumack: %s, sum=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">s</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;error from call sum</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);}</span><span class="w"></span>
<span class="w"> </span><span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>On the Pyhton side we have the following code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uartremote</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">ur</span><span class="o">=</span><span class="n">UartRemote</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">led</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;led&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;adding&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
  <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span>

<span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
<span class="n">ur</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>

<span class="n">ur</span><span class="o">.</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="struct-library">
<h2>Struct library<a class="headerlink" href="#struct-library" title="Permalink to this heading"></a></h2>
<p>We use the <code class="docutils literal notranslate"><span class="pre">struct</span></code> library with implemenations of <code class="docutils literal notranslate"><span class="pre">pack</span></code> and <code class="docutils literal notranslate"><span class="pre">unpack</span></code> supporting Python compatible format strings. The code can be found on <a class="reference external" href="https://github.com/svperbeast/struct">github.com/svperbeast/struct</a>.</p>
</section>
<section id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this heading"></a></h2>
<a class="reference external image-reference" href="https://uartremote.readthedocs.io/en/latest/?badge=latest"><img alt="Documentation Status" src="https://readthedocs.org/projects/uartremote/badge/?version=latest" /></a>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../SerialTalk/serialtalk.html" class="btn btn-neutral float-left" title="Welcome to the SerialTalk documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../mpy-robot-tools/docs/index.html" class="btn btn-neutral float-right" title="Installation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Anton, Ste7an.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>